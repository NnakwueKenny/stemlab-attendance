<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stemlab - Attendance</title>
    <link rel="stylesheet" href="./css/output.css">
</head>
<body>
    <script src="html5-qrcode.min.js"></script>
    <style>
        .result{
            background-color: green;
            color:#fff;
            padding:20px;
        }
    </style>
    <div class="flex flex-col items-center gap-4">
        <div class="flex justify-center bg-orange-500 text-white font-semibold w-full py-4 mb-4 md:mb-6">
            <h1 class="flex justify-center w-full max-w-3xl text-3xl uppercase">Attendance System</h1>
        </div>
        <div class="w-full max-w-3xl px-3">
            <div class='flex flex-col justify-center rounded-xl' id="reader"></div>
        </div>
        <div class="">
            <h4>SCAN RESULT</h4>
            <div id="result">Result Here</div>
        </div>
        <div class='w-full max-w-3xl px-4 mb-4'>
            <form class='details-form hidden flex flex-col gap-4 w-full border-2 rounded-xl px-6 md:px-8 py-8'>
                <div class='w-full'>
                    <label for="user" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400 text-orange-500 text-xl">User</label>
                    <select id="user" name='user' class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" required>
                        <option></option>
                        <option>Admin</option>
                        <option>Intern</option>
                    </select>
                </div>
                <div>
                    <label for="dept" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400 text-orange-500 text-xl">Department</label>
                    <select id="dept" name='dept' class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" required>
                        <option></option>
                        <option>IT</option>
                        <option>Software Dev Ops</option>
                        <option>Admin</option>
                        <option>Maintenance</option>
                        <option>Productivity</option>
                        <option>Intern</option>
                    </select>
                </div>
                <div>
                    <label for="session" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400 text-orange-500 text-xl">Session</label>
                    <select id="session" name='session' class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" required>
                        <option></option>
                        <option>Morning</option>
                        <option>Session</option>
                    </select>
                </div>
                <div class="sr-only">
                    <label for="qrcode"></label>
                    <input class='qr-code-response' type='text' name='qrcode' id='qrcode' placeholder='qrcode'>
                </div>
                <div>
                    <button type='button' class='submit-btn bg-orange-500 text-white px-4 py-2 rounded-lg w-full font-semibold'>Sign In</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const compileValues = async (userName, form) => {
            const submitBtn = document.querySelector('.submit-btn');

            submitBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const formInput = form.querySelectorAll('select');
                let userDetails = {};
                formInput.forEach(input => {
                    if (input.value == '') {
                        alert('All inputs are required!');
                        // submitValues();
                    } else {
                        userDetails[`${input.name}`] = input.value;
                    }
                });
                userDetails.qrcode = userName;
                console.log(JSON.stringify(userDetails));
                submitValues(userDetails);
            })

        }

        const submitValues = async (formData) => {
            console.log('Data fetching operation started');

            await fetch('https://stemlab-register.us-south.cf.appdomain.cloud',
                {
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                }
            )
            .then(response => {
                console.log('Data fetched')
                console.log('Response: '+response);
            })
            .catch (err => {
                console.log(err.json());
            })
            console.log('Data fetching operation ended!');
        }

        let userName;
        const onScanSuccess = (qrCodeMessage) => {
            userName = qrCodeMessage;
            const detailsForm = document.querySelector('.details-form');
            detailsForm.classList.remove('hidden');
            const qrCodeResponse = detailsForm.querySelector('.qr-code-response');
            qrCodeResponse.value = userName;
            document.getElementById('result').innerHTML = '<span class="result">'+qrCodeMessage+'</span>';

            html5QrcodeScanner.clear()
            .then(_ => {
                // the UI should be cleared here
                compileValues(userName, detailsForm);     
            }).catch(error => {
                // Could not stop scanning for reasons specified in `error`.
                // This conditions should ideally not happen.
            });
        }

        const onScanError = (errorMessage) => {
        //handle scan error
        }
        const html5QrcodeScanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess, onScanError);

        const reader = document.querySelector('#reader');
        const readerHeader = reader.querySelectorAll('div')[0];
        const readerStatusSpan = document.querySelector('#reader__status_span');
        const readerScanRegion = document.querySelector('#reader__scan_region');
        readerScanRegion.className += ' flex justify-center w-full gap-6 text-purple-800 font-bold';
        reader.className += ' flex justify-center w-full gap-6 md:gap-10 text-purple-800 font-bold';
        reader.querySelector('img').className += ' flex w-64';
        
        readerStatusSpan.style.display = 'flex';
        readerStatusSpan.style.color = '34 197 94';
        readerHeader.className += 'text-purple-800 font-bold';

    </script>
</body>
</html>